<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç»ªè¿½è¸ª - äººç”Ÿå‰§æœ¬</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/mood.css">
</head>
<body>
    <div class="mood-page">
        <!-- å¤´éƒ¨ -->
        <header class="mood-header">
            <a href="../profile/index.html" class="back-link">â† è¿”å›ä¸ªäººä¸­å¿ƒ</a>
            <h1>ğŸ˜Š æƒ…ç»ªè¿½è¸ª</h1>
            <p>è®°å½•æƒ…ç»ªï¼Œçœ‹è§æ¨¡å¼ï¼Œç†è§£è‡ªå·±</p>
        </header>

        <div class="mood-content">
            <!-- ä»Šæ—¥æ‰“å¡ -->
            <div class="mood-section">
                <div id="today-checkin-container"></div>
            </div>

            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="mood-section">
                <h2 class="mood-section-title">ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ</h2>
                <div id="mood-stats-container"></div>
            </div>

            <!-- æƒ…ç»ªè¶‹åŠ¿ -->
            <div class="mood-section">
                <div id="mood-trend-container"></div>
            </div>

            <!-- æ‰“å¡å†å² -->
            <div class="mood-section">
                <h2 class="mood-section-title">ğŸ“œ æ‰“å¡å†å²</h2>
                <div id="mood-history-container"></div>
            </div>
        </div>

        <!-- æ‰“å¡è¡¨å•å¼¹çª— -->
        <div id="checkin-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close-btn" id="close-modal">&times;</span>
                <div id="checkin-form-container"></div>
            </div>
        </div>
    </div>

    <script src="../js/mood-service.js"></script>
    <script src="../js/mood-ui.js"></script>
    <script>
        (function() {
            let currentChartDays = 7;
            let editingCheckin = null;

            // åˆå§‹åŒ–
            function init() {
                renderTodayCheckin();
                renderStats();
                renderTrend();
                renderHistory();
                bindEvents();
            }

            // æ¸²æŸ“ä»Šæ—¥æ‰“å¡
            function renderTodayCheckin() {
                const container = document.getElementById('today-checkin-container');
                MoodUI.renderQuickCheckin(container, {
                    onCheckin: (data) => {
                        if (data && data.level) {
                            // å¿«é€Ÿæ‰“å¡
                            MoodService.createCheckin({
                                level: data.level,
                                triggers: [],
                                note: ''
                            });
                            renderAll();
                        } else {
                            // æ‰“å¼€å®Œæ•´æ‰“å¡è¡¨å•
                            editingCheckin = data;
                            openCheckinModal(data);
                        }
                    }
                });
            }

            // æ¸²æŸ“ç»Ÿè®¡
            function renderStats() {
                const container = document.getElementById('mood-stats-container');
                MoodUI.renderMoodStats(container);
            }

            // æ¸²æŸ“è¶‹åŠ¿å›¾è¡¨
            function renderTrend() {
                const container = document.getElementById('mood-trend-container');
                MoodUI.renderMoodTrendChart(container, {
                    days: currentChartDays,
                    onDaysChange: (days) => {
                        currentChartDays = days;
                        renderTrend();
                    }
                });
            }

            // æ¸²æŸ“å†å²
            function renderHistory() {
                const container = document.getElementById('mood-history-container');
                MoodUI.renderMoodHistory(container, { limit: 10 });
            }

            // æ‰“å¼€æ‰“å¡å¼¹çª—
            function openCheckinModal(checkin = null) {
                const modal = document.getElementById('checkin-modal');
                const container = document.getElementById('checkin-form-container');
                
                MoodUI.renderMoodCheckinForm(container, {
                    existingCheckin: checkin,
                    onSave: (data) => {
                        MoodService.createCheckin(data);
                        closeCheckinModal();
                        renderAll();
                    },
                    onCancel: closeCheckinModal
                });
                
                modal.style.display = 'flex';
            }

            // å…³é—­æ‰“å¡å¼¹çª—
            function closeCheckinModal() {
                document.getElementById('checkin-modal').style.display = 'none';
                editingCheckin = null;
            }

            // æ¸²æŸ“æ‰€æœ‰ç»„ä»¶
            function renderAll() {
                renderTodayCheckin();
                renderStats();
                renderTrend();
                renderHistory();
            }

            // ç»‘å®šäº‹ä»¶
            function bindEvents() {
                document.getElementById('close-modal').addEventListener('click', closeCheckinModal);
                
                document.getElementById('checkin-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'checkin-modal') {
                        closeCheckinModal();
                    }
                });
            }

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
