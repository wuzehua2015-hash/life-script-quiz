<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥è§‰å¯Ÿæ—¥è®° - äººç”Ÿå‰§æœ¬</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/diary.css">
</head>
<body>
    <div class="diary-page">
        <!-- å¤´éƒ¨ -->
        <header class="diary-header">
            <a href="../guidance/plan.html" class="back-link">â† è¿”å›21å¤©è®¡åˆ’</a>
            <h1>ğŸ“ æ¯æ—¥è§‰å¯Ÿæ—¥è®°</h1>
            <p>è®°å½•è§‰å¯Ÿï¼Œè§è¯æ”¹å˜</p>
        </header>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="diary-stats" id="diary-stats"></div>

        <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
        <div class="diary-tabs">
            <button class="diary-tab active" data-tab="list">æ—¥è®°åˆ—è¡¨</button>
            <button class="diary-tab" data-tab="calendar">æ—¥å†è§†å›¾</button>
        </div>

        <!-- æ—¥è®°åˆ—è¡¨è§†å›¾ -->
        <div id="diary-list-view" class="diary-list"></div>

        <!-- æ—¥å†è§†å›¾ -->
        <div id="diary-calendar-view" class="diary-calendar" style="display: none;"></div>

        <!-- ç¼–è¾‘å™¨å®¹å™¨ -->
        <div id="diary-editor" style="display: none;"></div>
    </div>

    <!-- æ–°å»ºæ—¥è®°æŒ‰é’® -->
    <button class="diary-fab" id="new-diary-btn" title="å†™æ—¥è®°">+</button>

    <script src="../js/diary-service.js"></script>
    <script src="../js/diary-ui.js"></script>
    <script>
        (function() {
            let currentTab = 'list';
            let currentCalendarYear = new Date().getFullYear();
            let currentCalendarMonth = new Date().getMonth();
            let editingDiaryId = null;

            // åˆå§‹åŒ–
            function init() {
                renderStats();
                renderDiaryList();
                bindEvents();
            }

            // æ¸²æŸ“ç»Ÿè®¡
            function renderStats() {
                const container = document.getElementById('diary-stats');
                DiaryUI.renderStats(container);
            }

            // æ¸²æŸ“æ—¥è®°åˆ—è¡¨
            function renderDiaryList() {
                const container = document.getElementById('diary-list-view');
                DiaryUI.renderDiaryList(container, {
                    onEdit: handleEditDiary,
                    onDelete: handleDeleteDiary
                });
            }

            // æ¸²æŸ“æ—¥å†
            function renderCalendar() {
                const container = document.getElementById('diary-calendar-view');
                DiaryUI.renderCalendar(container, {
                    year: currentCalendarYear,
                    month: currentCalendarMonth,
                    onDateClick: handleDateClick,
                    onMonthChange: handleMonthChange
                });
            }

            // æ¸²æŸ“ç¼–è¾‘å™¨
            function renderEditor(diary = null) {
                const container = document.getElementById('diary-editor');
                editingDiaryId = diary ? diary.id : null;
                
                DiaryUI.renderDiaryEditor(container, {
                    diary: diary,
                    onSave: handleSaveDiary,
                    onCancel: handleCancelEdit
                });
                
                container.style.display = 'block';
                document.getElementById('diary-list-view').style.display = 'none';
                document.getElementById('diary-calendar-view').style.display = 'none';
                document.querySelector('.diary-tabs').style.display = 'none';
                document.getElementById('diary-stats').style.display = 'none';
                document.getElementById('new-diary-btn').style.display = 'none';
            }

            // éšè—ç¼–è¾‘å™¨
            function hideEditor() {
                const container = document.getElementById('diary-editor');
                container.style.display = 'none';
                container.innerHTML = '';
                
                document.querySelector('.diary-tabs').style.display = 'flex';
                document.getElementById('diary-stats').style.display = 'block';
                document.getElementById('new-diary-btn').style.display = 'flex';
                
                if (currentTab === 'list') {
                    document.getElementById('diary-list-view').style.display = 'flex';
                } else {
                    document.getElementById('diary-calendar-view').style.display = 'block';
                }
                
                editingDiaryId = null;
            }

            // å¤„ç†ä¿å­˜æ—¥è®°
            function handleSaveDiary(data) {
                if (editingDiaryId) {
                    DiaryService.updateDiary(editingDiaryId, data);
                } else {
                    DiaryService.createDiary(data);
                }
                
                hideEditor();
                renderStats();
                
                if (currentTab === 'list') {
                    renderDiaryList();
                } else {
                    renderCalendar();
                }
            }

            // å¤„ç†å–æ¶ˆç¼–è¾‘
            function handleCancelEdit() {
                hideEditor();
            }

            // å¤„ç†ç¼–è¾‘æ—¥è®°
            function handleEditDiary(diaryId) {
                const diary = DiaryService.getDiaryById(diaryId);
                if (diary) {
                    renderEditor(diary);
                }
            }

            // å¤„ç†åˆ é™¤æ—¥è®°
            function handleDeleteDiary(diaryId) {
                const diary = DiaryService.getDiaryById(diaryId);
                if (diary) {
                    DiaryUI.confirmDelete(diary, () => {
                        DiaryService.deleteDiary(diaryId);
                        renderStats();
                        renderDiaryList();
                    });
                }
            }

            // å¤„ç†æ—¥æœŸç‚¹å‡»
            function handleDateClick(date) {
                const existingDiary = DiaryService.getDiaryByDate(date);
                renderEditor(existingDiary || { date: date });
            }

            // å¤„ç†æœˆä»½åˆ‡æ¢
            function handleMonthChange(year, month) {
                currentCalendarYear = year;
                currentCalendarMonth = month;
                renderCalendar();
            }

            // ç»‘å®šäº‹ä»¶
            function bindEvents() {
                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.diary-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.diary-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        currentTab = tab.dataset.tab;
                        
                        if (currentTab === 'list') {
                            document.getElementById('diary-list-view').style.display = 'flex';
                            document.getElementById('diary-calendar-view').style.display = 'none';
                            renderDiaryList();
                        } else {
                            document.getElementById('diary-list-view').style.display = 'none';
                            document.getElementById('diary-calendar-view').style.display = 'block';
                            renderCalendar();
                        }
                    });
                });

                // æ–°å»ºæ—¥è®°æŒ‰é’®
                document.getElementById('new-diary-btn').addEventListener('click', () => {
                    renderEditor();
                });
            }

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
